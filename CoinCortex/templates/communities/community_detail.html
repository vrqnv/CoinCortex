{% extends "base.html" %}
{% load static %}

{% block title %}{{ community.name }} - CoinCortex{% endblock %}

{% block content %}
        <div class="community-detail">
            <div class="community-header">
                <div class="community-avatar large">
                    {% if community.avatar %}
                        <img src="{{ community.avatar.url }}" alt="{{ community.name }}">
                    {% else %}
                        <div class="avatar-placeholder large">{{ community.name|first|upper }}</div>
                    {% endif %}
                </div>
                
                <div class="community-meta">
                    <h1>{{ community.name }}</h1>
                    <p class="community-description">{{ community.description }}</p>
                    
                    <div class="community-actions">
                        {% if user.is_authenticated %}
                            {% if is_member %}
                                <button class="btn btn-outline leave-btn" 
                                        data-community-id="{{ community.id }}">
                                    ‚úÖ –í—ã —É—á–∞—Å—Ç–Ω–∏–∫
                                </button>
                            {% else %}
                                <button class="btn btn-primary join-btn" 
                                        data-community-id="{{ community.id }}">
                                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É
                                </button>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'login' %}" class="btn btn-primary">–í–æ–π—Ç–∏ –¥–ª—è —É—á–∞—Å—Ç–∏—è</a>
                        {% endif %}
                        
                        <span class="members-count">üë• {{ members_count }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                    </div>
                </div>
            </div>

            <div class="community-content">
                <div class="community-posts">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è</h3>
                    {% if community.posts.all %}
                        {% for post in community.posts.all %}
                        <div class="post-card">
                            <div class="post-header">
                                <div class="post-author">
                                    <div class="post-avatar">
                                        {{ post.author.username|first|upper }}
                                    </div>
                                    <div class="author-info">
                                        <strong>{{ post.author.username }}</strong>
                                        <span class="post-date">{{ post.created|date:"d.m.Y H:i" }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="post-content">
                                {{ post.content|linebreaksbr }}
                            </div>
                            <div class="post-actions">
                                <button class="like-btn">‚ù§Ô∏è</button>
                                <button class="comment-btn">üí¨</button>
                                <button class="share-btn">‚ÜóÔ∏è</button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏–π –≤ —ç—Ç–æ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ.</p>
                            <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –ø–æ–¥–µ–ª–∏—Ç—Å—è –Ω–æ–≤–æ—Å—Ç—å—é!</p>
                        </div>
                    {% endif %}
                </div>
                
                <div class="community-sidebar">
                    <div class="sidebar-section">
                        <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h4>
                        <div class="members-preview">
                            {% for member in community.members.all|slice:":8" %}
                                <div class="member-avatar small" title="{{ member.username }}">
                                    {{ member.username|first|upper }}
                                </div>
                            {% endfor %}
                            {% if members_count > 8 %}
                                <div class="more-members">+{{ members_count|add:"-8" }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                        <p>–°–æ–∑–¥–∞—Ç–µ–ª—å: <strong>{{ community.creator.username }}</strong></p>
                        <p>–°–æ–∑–¥–∞–Ω–æ: {{ community.created|date:"d.m.Y" }}</p>
                    </div>
                </div>
            </div>
        </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const joinButton = document.querySelector('.join-btn, .leave-btn');
        
        if (joinButton) {
            joinButton.addEventListener('click', function() {
                const communityId = this.dataset.communityId;
                const isCurrentlyJoined = this.classList.contains('leave-btn');
                
                fetch(`/communities/join/${communityId}/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.joined) {
                        // –°—Ç–∞–ª —É—á–∞—Å—Ç–Ω–∏–∫–æ–º
                        this.textContent = '‚úÖ –í—ã —É—á–∞—Å—Ç–Ω–∏–∫';
                        this.classList.remove('btn-primary', 'join-btn');
                        this.classList.add('btn-outline', 'leave-btn');
                    } else {
                        // –í—ã—à–µ–ª –∏–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
                        this.textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É';
                        this.classList.remove('btn-outline', 'leave-btn');
                        this.classList.add('btn-primary', 'join-btn');
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                    const membersCount = document.querySelector('.members-count');
                    membersCount.textContent = `üë• ${data.members_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                });
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
    </script>
{% endblock %}