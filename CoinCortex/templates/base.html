<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <title>{% block title %}Concord{% endblock %}</title>
</head>
<body>
    <header>
        <nav>
            <button class="mobile-menu-toggle" aria-label="Меню">☰</button>
            <ul class="nav-menu">
                {% if user.is_authenticated %}
                    <li class="nav-left"><a href="{% url 'index' %}">Главная</a></li>
                    <li class="nav-left"><a href="{% url 'chat' %}">Чаты</a></li>
                    <li class="nav-left"><a href="{% url 'groups_list' %}">Сообщества</a></li>
                    <li class="nav-center"><a href="{% url 'index' %}"><img src="{% static 'logo.png' %}" alt="Logo" style="height: 40px; width: auto;"></a></li>
                    <li class="nav-right"><a href="{% url 'notifications' %}">Уведомления{% if unread_notifications %}<span style="background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8rem; margin-left: 5px;">{{ unread_notifications }}</span>{% endif %}</a></li>
                    <li class="nav-right"><a href="{% url 'friends' %}">Друзья</a></li>
                    <li class="nav-right"><a href="{% url 'profile' %}">Профиль</a></li>
                {% else %}
                    <li class="nav-center-not-auth"><a href="{% url 'index' %}"><img src="{% static 'logo.png' %}" alt="Logo" style="height: 40px; width: auto;"></a></li>
                    <li class="nav-right"><a href="{% url 'login' %}">Войти</a></li>
                    <li class="nav-right"><a href="{% url 'register' %}">Регистрация</a></li>
                {% endif %}
            </ul>
        </nav>
    </header>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <footer>
        <p>Concord 2025</p>
    </footer>

    <script>
        // Mobile menu toggle
        document.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.querySelector('.mobile-menu-toggle');
            const navMenu = document.querySelector('.nav-menu');
            
            if (menuToggle && navMenu) {
                menuToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!navMenu.contains(event.target) && !menuToggle.contains(event.target)) {
                        navMenu.classList.remove('active');
                    }
                });
            }
            
            // Live Search для всех поисковых форм
            // Находим все поисковые формы (включая формы с id search-form)
            const searchForms = document.querySelectorAll('.search-form, form[id="search-form"]');
            
            searchForms.forEach(function(form) {
                const searchInput = form.querySelector('.search-input');
                const searchBtn = form.querySelector('.search-btn');
                
                if (searchInput) {
                    let searchTimeout;
                    let isSearching = false;
                    
                    // Функция для выполнения поиска
                    function performSearch() {
                        if (isSearching) return;
                        isSearching = true;
                        searchInput.classList.add('loading');
                        
                        // Сохраняем все параметры формы (select, hidden inputs и т.д.)
                        const formData = new FormData(form);
                        const params = new URLSearchParams(formData);
                        
                        // Отправляем запрос через fetch для более плавной работы
                        const url = form.action || window.location.pathname;
                        const fullUrl = url + (url.includes('?') ? '&' : '?') + params.toString();
                        
                        // Используем fetch для обновления страницы без полной перезагрузки
                        fetch(fullUrl, {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                            }
                        }).then(function(response) {
                            return response.text();
                        }).then(function(html) {
                            // Если это AJAX запрос, можно обновить только нужную часть
                            // Но для простоты делаем полную перезагрузку
                            window.location.href = fullUrl;
                        }).catch(function(error) {
                            // В случае ошибки просто отправляем форму обычным способом
                            form.submit();
                        });
                        
                        // Убираем индикатор загрузки через небольшую задержку
                        setTimeout(function() {
                            searchInput.classList.remove('loading');
                            isSearching = false;
                        }, 1000);
                    }
                    
                    // Live search при вводе
                    searchInput.addEventListener('input', function() {
                        clearTimeout(searchTimeout);
                        const query = this.value.trim();
                        
                        // Если запрос длиннее 2 символов или пустой, выполняем поиск
                        if (query.length >= 2 || query.length === 0) {
                            searchTimeout = setTimeout(function() {
                                performSearch();
                            }, 500); // Задержка 500мс для уменьшения количества запросов
                        }
                    });
                    
                    // Поиск при нажатии Enter
                    searchInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            clearTimeout(searchTimeout);
                            performSearch();
                        }
                    });
                    
                    // Поиск при клике на кнопку
                    if (searchBtn) {
                        searchBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            clearTimeout(searchTimeout);
                            performSearch();
                        });
                    }
                }
            });
            
            // Отслеживание прокрутки для изменения цвета шапки
            const header = document.querySelector('header');
            const main = document.querySelector('main');
            
            function updateHeaderColor() {
                if (!header || !main) return;
                
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const headerHeight = header.offsetHeight;
                
                // Проверяем, есть ли белые карточки под шапкой
                const cards = document.querySelectorAll('.profile-card, .posts-section, .welcome-card, .auth-card, .search-section, .chats-list, .post-card');
                let hasWhiteCard = false;
                
                cards.forEach(function(card) {
                    const rect = card.getBoundingClientRect();
                    // Если карточка видна и находится в области шапки
                    if (rect.top < headerHeight + 50 && rect.bottom > 0) {
                        hasWhiteCard = true;
                    }
                });
                
                // Если прокрутили достаточно и есть белые карточки, меняем стиль
                if (scrollTop > 50 && hasWhiteCard) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            }
            
            // Обновляем при прокрутке (с throttling для производительности)
            let ticking = false;
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(function() {
                        updateHeaderColor();
                        ticking = false;
                    });
                    ticking = true;
                }
            });
            
            // Обновляем при загрузке
            updateHeaderColor();
            // Обновляем при изменении размера окна
            window.addEventListener('resize', updateHeaderColor);
            // Обновляем при изменении DOM (для динамического контента)
            const observer = new MutationObserver(updateHeaderColor);
            if (main) {
                observer.observe(main, { childList: true, subtree: true });
            }
            
            // Раскрытие/скрытие комментариев
            const commentToggleButtons = document.querySelectorAll('.comment-toggle-btn');
            commentToggleButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    const commentsSection = document.getElementById('comments-' + postId);
                    if (commentsSection) {
                        if (commentsSection.style.display === 'none') {
                            commentsSection.style.display = 'block';
                            commentsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        } else {
                            commentsSection.style.display = 'none';
                        }
                    }
                });
            });
            
            // AJAX для лайков на главной странице
            const likeForms = document.querySelectorAll('.like-form');
            likeForms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const button = form.querySelector('.like-btn');
                    const likesCountSpan = form.querySelector('.likes-count');
                    const isLiked = button.getAttribute('data-liked') === 'true';
                    
                    fetch(window.location.pathname, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.success) {
                            // Обновляем состояние кнопки
                            button.setAttribute('data-liked', data.is_liked);
                            if (data.is_liked) {
                                button.style.color = '#ef4444';
                            } else {
                                button.style.color = '';
                            }
                            if (likesCountSpan) {
                                likesCountSpan.textContent = data.likes_count;
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                        // В случае ошибки отправляем форму обычным способом
                        form.submit();
                    });
                });
            });
            
            // Автоматическое определение часового пояса и форматирование дат
            function formatDateInUserTimezone(dateElement) {
                if (!dateElement || !dateElement.textContent) return;
                
                const dateText = dateElement.textContent.trim();
                if (!dateText) return;
                
                // Парсим дату в формате "dd.mm.yyyy HH:MM"
                const match = dateText.match(/(\d{2})\.(\d{2})\.(\d{4})\s+(\d{2}):(\d{2})/);
                if (!match) return;
                
                const [, day, month, year, hour, minute] = match;
                // Создаем дату в UTC (предполагаем, что сервер хранит в UTC)
                const utcDate = new Date(Date.UTC(year, month - 1, day, hour, minute));
                
                // Форматируем в локальном времени пользователя
                const localDate = new Date(utcDate);
                const formattedDate = localDate.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                dateElement.textContent = formattedDate;
            }
            
            // Применяем форматирование ко всем датам на странице
            document.querySelectorAll('.post-date, .message-time').forEach(function(dateElement) {
                formatDateInUserTimezone(dateElement);
            });
        });
    </script>
</body>
</html>

