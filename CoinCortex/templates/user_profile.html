<!-- templates/user_profile.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å - {{ profile_user.username }}{% endblock %}

{% block content %}

        <div class="profile-layout">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ø—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ—Å—Ç—ã -->
            <div class="profile-main">
                <div class="profile-card">
                    <div class="user-info">
                        <div class="avatar" style="{% if profile_user.profile.avatar %}background-image: url('{{ profile_user.profile.avatar.url }}'); background-size: cover;{% endif %}">
                            {% if not profile_user.profile.avatar %}
                                {{ profile_user.username|first|upper }}
                            {% endif %}
                        </div>
                        <div class="user-details">
                            <h1>
                                {% if profile_user.profile.first_name or profile_user.profile.last_name %}
                                    {{ profile_user.profile.get_full_name }}
                                {% else %}
                                    {{ profile_user.username }}
                                {% endif %}
                            </h1>
                            {% if profile_user.profile.first_name or profile_user.profile.last_name %}
                                <p style="color: var(--gray-500); font-size: 0.95rem; margin-bottom: 0.5rem;">@{{ profile_user.username }}</p>
                            {% endif %}
                            
                            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                            {% if profile_user.profile.bio %}
                                <p style="color: var(--gray-700); font-size: 1rem; margin-bottom: 1rem; line-height: 1.6;">{{ profile_user.profile.bio }}</p>
                            {% endif %}
                            
                            {% if profile_user.profile.birth_date %}
                                <p style="color: var(--gray-500); font-size: 0.9rem; margin-bottom: 1rem;">
                                    üìÖ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {{ profile_user.profile.birth_date|date:"d.m.Y" }}
                                </p>
                            {% endif %}
                            
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –¥—Ä—É–∑—å—è–º–∏ -->
                            {% if user.username != profile_user.username %}
                            <div class="friend-actions" style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; margin-top: 1rem;">
                                {% if is_friend %}
                                    <span class="friend-status">‚úÖ –î—Ä—É–≥</span>
                                    <a href="/chat/start/{{ profile_user.username }}/" class="start-chat-btn" style="text-decoration: none; display: inline-block;">
                                        üí¨ –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                                    </a>
                                    <form method="POST" action="{% url 'profile' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="remove_friend" value="{{ profile_user.username }}">
                                        <button type="submit" class="remove-friend-btn large">–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π</button>
                                    </form>
                                {% elif friend_request_sent %}
                                    <span class="friend-status">‚è≥ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</span>
                                    <a href="/chat/start/{{ profile_user.username }}/" class="start-chat-btn" style="text-decoration: none; display: inline-block;">
                                        üí¨ –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                                    </a>
                                {% elif incoming_request %}
                                    <form method="POST" action="{% url 'profile' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="accept_friend" value="{{ incoming_request.id }}">
                                        <button type="submit" class="accept-friend-btn">–ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É</button>
                                    </form>
                                {% else %}
                                    <a href="/chat/start/{{ profile_user.username }}/" class="start-chat-btn" style="text-decoration: none; display: inline-block;">
                                        üí¨ –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                                    </a>
                                    <form method="POST" action="{% url 'profile' %}" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="add_friend" value="{{ profile_user.username }}">
                                        <button type="submit" class="add-friend-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
                                    </form>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ –Ω–∞ —Å—Ç–µ–Ω–µ –¥—Ä—É–≥–∞ -->
                {% if is_friend %}
                <div class="create-post-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-bottom: 1rem; color: #1f2937; font-size: 1.25rem;">–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞ —Å—Ç–µ–Ω–µ {{ profile_user.username }}</h3>
                    <form method="POST" enctype="multipart/form-data" class="post-form">
                        {% csrf_token %}
                        <textarea name="content" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; font-family: inherit; resize: vertical; font-size: 0.95rem; transition: border-color 0.2s;" onfocus="this.style.borderColor='#7C3AED';" onblur="this.style.borderColor='#e5e7eb';"></textarea>
                        <div style="margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <label for="image-upload" style="cursor: pointer; padding: 0.5rem 1rem; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem; color: #6b7280; transition: background-color 0.2s;" onmouseover="this.style.background='#e5e7eb';" onmouseout="this.style.background='#f3f4f6';">
                                üì∑ –í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            </label>
                            <input type="file" id="image-upload" name="image" accept="image/*" style="display: none;" onchange="if(this.value) { this.previousElementSibling.textContent = 'üì∑ ' + this.files[0].name; }">
                        </div>
                        <button type="submit" class="btn-primary" style="margin-top: 1rem; padding: 0.75rem 2rem; background: #7C3AED; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.2s;" onmouseover="this.style.background='#6d28d9';" onmouseout="this.style.background='#7C3AED';">
                            –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                        </button>
                    </form>
                </div>
                {% endif %}

                <!-- –ë–ª–æ–∫ –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <div class="posts-section">
                    <h2>–ü–æ—Å—Ç—ã –Ω–∞ —Å—Ç–µ–Ω–µ {{ profile_user.username }}</h2>
                    <div class="posts-list">
                        {% if posts %}
                            {% for item in posts %}
                            <div class="post-card">
                                <div class="post-header">
                                    <div class="post-author">
                                        <div class="post-avatar">
                                            {{ item.post.author.username|first|upper }}
                                        </div>
                                        <strong><a href="{% url 'user_profile' username=item.post.author.username %}" style="color: #1f2937; text-decoration: none;">{{ item.post.author.username }}</a></strong>
                                    </div>
                                    <span class="post-date">{{ item.post.created|date:"d.m.Y H:i" }}</span>
                                </div>
                                <div class="post-content">
                                    {{ item.post.content|linebreaksbr }}
                                    {% if item.post.image %}
                                        <div style="margin-top: 1rem;">
                                            <img src="{{ item.post.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-width: 100%; border-radius: 8px;">
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="post-actions">
                                    <form method="POST" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="like_post" value="{{ item.post.id }}">
                                        <button type="submit" class="like-btn" style="{% if item.is_liked %}color: #ef4444;{% endif %}">
                                            ‚ù§Ô∏è {{ item.likes_count }}
                                        </button>
                                    </form>
                                    <span class="comment-btn">üí¨ {{ item.comments_count }}</span>
                                    {% if item.comments_count > 0 %}
                                        <div class="comments-section" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f3f4f6;">
                                            <h4 style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</h4>
                                            {% for comment_data in item.comments|slice:":3" %}
                                            <div class="comment-item" style="padding: 0.5rem; background: #f9fafb; border-radius: 8px; margin-bottom: 0.5rem;">
                                                <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <strong style="font-size: 0.85rem;">
                                                            <a href="{% url 'user_profile' username=comment_data.comment.author.username %}" style="color: #7C3AED; text-decoration: none;">{{ comment_data.comment.author.username }}</a>:
                                                        </strong>
                                                        <span style="font-size: 0.75rem; color: #6b7280;">{{ comment_data.comment.created|date:"d.m.Y H:i" }}</span>
                                                    </div>
                                                    {% if user.is_authenticated %}
                                                    <form method="POST" style="display: inline; margin: 0;">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="like_comment" value="{{ comment_data.comment.id }}">
                                                        <button type="submit" class="like-btn" style="{% if comment_data.is_liked %}color: #ef4444;{% endif %} padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                                            ‚ù§Ô∏è {{ comment_data.likes_count }}
                                                        </button>
                                                    </form>
                                                    {% else %}
                                                    <span style="font-size: 0.8rem; color: #6b7280;">‚ù§Ô∏è {{ comment_data.likes_count }}</span>
                                                    {% endif %}
                                                </div>
                                                <span style="font-size: 0.85rem;">{{ comment_data.comment.content|linebreaksbr }}</span>
                                            </div>
                                            {% endfor %}
                                            <form method="POST" style="margin-top: 0.5rem;">
                                                {% csrf_token %}
                                                <input type="hidden" name="comment_post" value="{{ item.post.id }}">
                                                <input type="text" name="comment_text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                                                <button type="submit" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #7C3AED; color: white; border: none; border-radius: 8px; cursor: pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                            </form>
                                        </div>
                                    {% else %}
                                        <form method="POST" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f3f4f6;">
                                            {% csrf_token %}
                                            <input type="hidden" name="comment_post" value="{{ item.post.id }}">
                                            <input type="text" name="comment_text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
                                            <button type="submit" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #7C3AED; color: white; border: none; border-radius: 8px; cursor: pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-posts">
                                <p>–ù–∞ —Å—Ç–µ–Ω–µ {{ profile_user.username }} –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
{% endblock %}